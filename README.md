# Документация API

Статическая документация по эндпоинтам API на Nuxt 4 + Nuxt Content 3. Данные подтягиваются из внешнего API при сборке, список страниц и навигация строятся автоматически.

---

## Главные возможности

### 1. Генерация статических .html страниц для деплоя на CDN

При `npm run generate`:

- Выполняется один запрос к внешнему API (`appload`), ответ сохраняется в `public/staticData/endpoints.json`.
- Nitro пререндерит все страницы документации: главная, `/docs`, и каждая страница эндпоинта (например `/docs/products/search`) собирается в статический HTML.
- Итоговая сборка в `.output/public/` — готовый статический сайт для выкладки на CDN или любой хостинг статики (Netlify, Vercel, S3 + CloudFront и т.д.). Никакого рантайм-сервера не требуется.

Конфигурация: хук `nitro:config` в `nuxt.config.ts` — запрос к API, запись `endpoints.json`, формирование списка роутов для `prerender.routes`.

### 2. Автогенерация страниц с помощью программной маршрутизации

- Маршруты не задаются вручную: список страниц строится из ответа API (`page_data.unauth.paths`). Для каждой пары секция + путь добавляется роут вида `/docs/[section]/[path]` (реализовано через `pages/docs/[...slug].vue`).
- Один шаблон страницы эндпоинта: таблица «Информация о запросе», параметры тела из API, опционально Markdown из `content/docs/` (если файла нет — заглушка «Документация в разработке»).
- Навигация (сайдбар) генерируется из тех же данных: секции, эндпоинты, плашки метода (GET/POST), краткие описания на русском из `config/menu-descriptions.ts`.

Используются: `useEndpoints()` (загрузка данных), `useDocsNavigation()` (дерево групп → секции → эндпоинты), динамический slug в `app/pages/docs/[...slug].vue`.

### 3. Оптимизированный простой поиск

- Поиск по эндпоинтам: по названию роута, заголовку и описанию. Без морфологии, подстрока в нижнем регистре, до 10 подсказок, сортировка (точное совпадение в title → вхождение в title → остальные).
- Индекс строится на клиенте из статического `public/staticData/endpoints.json` (тот же файл, что и для страниц) и при необходимости из навигации (`useDocsNavigation`) как fallback. Отдельный поисковый сервер не нужен.
- Поиск доступен на всех страницах (хедер в `app.vue`), с подсказками (dropdown) и переходом по выбору. Без Pinia — состояние через composable `useSearch()` и обычные `ref`, чтобы не зависеть от payload при навигации.

---

## Решённые проблемы и как они решены

### Поиск не работал в preview после SSG

**Проблема:** После `nuxt generate` и `npm run preview` при вводе в строку поиска список подсказок не появлялся или был пуст.

**Причины:**  
1) Поиск опирался на данные из `useDocsNavigation()` → `useEndpoints()`, которые при первой загрузке в preview могли ещё не быть в payload.  
2) Условие показа выпадающего списка было «только если есть результаты» — при пустом индексе список не открывался.

**Решение:**

- Введена отдельная загрузка индекса для поиска: на клиенте один раз запрашивается `/staticData/endpoints.json`, из ответа строится плоский список эндпоинтов (та же логика, что в навигации). Так поиск не зависит от порядка гидрации payload.
- Выпадающий список показывается при фокусе и вводе от 2 символов даже без результатов: отображаются состояния «Загрузка…» или «Ничего не найдено», чтобы интерфейс поиска всегда был доступен.

### Поиск не работал на вложенных страницах (/docs/.../...)

**Проблема:** На главной и на `/docs` поиск работал, на странице конкретного эндпоинта (например `/docs/products/search`) — нет.

**Решение:**

- Добавлена подгрузка индекса при смене маршрута: при пустом списке эндпоинтов для поиска вызывается загрузка из `/staticData/endpoints.json`. Так индекс появляется и на вложенных страницах (в т.ч. при прямом заходе по ссылке).

---

## Что ещё реализовано

- **Навигация из API** — сайдбар с секциями и эндпоинтами, сворачиваемые блоки, плашки метода (GET/POST и т.д.), краткие описания на русском из `app/config/menu-descriptions.ts`.
- **Контент** — таблица «Информация о запросе», параметры тела из API, опционально Markdown из коллекции `docs` (источник `content/docs/`), описанной в `content.config.ts` (если нет — заглушка «Документация в разработке»).
- **Хлебные крошки и TOC** — динамические крошки по пути, оглавление справа из контента (Nuxt Content 3: `doc.body.toc.links`) + фиксированные пункты (информация о запросе, параметры тела).
- **Поиск** — компонент в хедере (`app/app.vue` + `SearchDropdown`), подсказки по эндпоинтам и (в dev) по заголовкам из Nuxt Content; навигация стрелками и Enter.

---

## Структура проекта

Исходный код приложения в каталоге `app/` (Nuxt 4). В корне — конфигурация, сервер, контент и статика.

```
api-docs/
├── app/
│   ├── app.vue                 # Корень: хедер с поиском, <NuxtPage />
│   ├── config/
│   │   └── menu-descriptions.ts # Русские подписи секций и эндпоинтов
│   ├── composables/
│   │   ├── useDocsNavigation.ts # Дерево навигации из API
│   │   ├── useEndpoints.ts      # Загрузка данных (статический JSON или /api/endpoints)
│   │   ├── useSearch.ts         # Поиск: индекс из JSON, подсказки, ref-состояние
│   │   └── useDocToc.ts         # Оглавление из контента (Nuxt Content 3)
│   ├── components/
│   │   ├── DocsBreadcrumbs.vue
│   │   ├── DocsSidebar.vue      # Секции + эндпоинты, сворачивание, описания
│   │   ├── DocsTableOfContents.vue
│   │   └── SearchDropdown.vue   # Выпадающий список подсказок поиска
│   └── pages/
│       ├── index.vue            # Главная → ссылка на /docs
│       └── docs/
│           ├── index.vue        # Список всех эндпоинтов
│           └── [...slug].vue    # Страница эндпоинта по slug
├── content/
│   └── docs/
│       └── products-search.md   # Markdown для /docs/products/search (по желанию)
├── content.config.ts           # Коллекция docs для @nuxt/content 3
├── server/
│   └── api/
│       └── endpoints.ts         # Прокси к https://main.nointerest.ru/api/appload
├── public/
│   └── staticData/
│       └── endpoints.json       # Создаётся при generate из ответа appload
└── nuxt.config.ts              # Хук nitro:config — запрос к API, запись endpoints.json, роуты для prerender
```

---

## Запуск

```bash
npm install
npm run dev      # Разработка, данные с /api/endpoints или /staticData/endpoints.json
npm run generate # SSG: запрос к API → endpoints.json + пререндер страниц
npm run preview  # Просмотр результата generate
```

---

## Добавление описаний эндпоинтов на русском

В `app/config/menu-descriptions.ts`:

- **sectionDescriptions** — подписи секций (address_hints, auth, products, …).
- **endpointDescriptions** — подписи эндпоинтов по точному **url_name** из API (например `auth_new_otp_request`, `products_search`).

Если для эндпоинта нет ключа в `endpointDescriptions`, в меню подставляется поле `summary` из API (англ.).

---

## Дополнительный Markdown для эндпоинта

Файл в `content/docs/` по пути из slug через дефис: для `/docs/products/search` — `content/docs/products-search.md`. Если файла нет, на странице показывается блок «Документация в разработке»; таблица запроса и параметры из API выводятся в любом случае.

---

## Технологии

- **Nuxt 4** (^4.3.1), **Vue 3** (^3.5), **TypeScript** (^5.9)
- **@nuxt/content** 3 — Markdown через коллекции и SQLite (`better-sqlite3`), конфигурация в `content.config.ts`
- **Nitro** — SSG, prerender, server API

Подробности миграции с Nuxt 3 и Content 2 — в [UPGRADE.md](UPGRADE.md).
